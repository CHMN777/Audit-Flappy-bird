<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CA Audit Run</title>
    <style>
        /* Prevents scrolling and bouncing on mobile */
        * { touch-action: manipulation; }
        body { 
            margin: 0; 
            background: #2c3e50; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden; 
            font-family: sans-serif; 
        }
        canvas { 
            border: 4px solid #f1c40f; 
            background: #3498db; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// 1. Assets (Added fallback colors if images don't load)
const birdImg = new Image(); birdImg.src = 'bird.png';
const pipeImg = new Image(); pipeImg.src = 'pipe.png';
const music = new Audio('music.mp3');
const gameOverSound = new Audio('gameover.mp3');
music.loop = true;

// 2. Variables
let bird = { x: 50, y: 300, w: 40, h: 40, gravity: 0.6, lift: -10, velocity: 0 };
let pipes = [];
let frame = 0;
let score = 0;
let gameStarted = false;
let isGameOver = false;

function draw() {
    if (isGameOver) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!gameStarted) {
        ctx.fillStyle = "white";
        ctx.font = "bold 22px Arial";
        ctx.textAlign = "center";
        ctx.fillText("TAP SCREEN TO START AUDIT", canvas.width/2, canvas.height/2);
        return;
    }

    // Physics
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;

    // Draw Bird
    if (birdImg.complete && birdImg.naturalWidth !== 0) {
        ctx.drawImage(birdImg, bird.x, bird.y, bird.w, bird.h);
    } else {
        ctx.fillStyle = "#f1c40f";
        ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
    }

    // Pipes Logic
    if (frame % 90 === 0) {
        let gap = 160;
        let minHeight = 50;
        let pipeHeight = Math.random() * (canvas.height - gap - 100) + minHeight;
        pipes.push({ x: canvas.width, top: pipeHeight, bottom: pipeHeight + gap, passed: false });
    }

    for (let i = pipes.length - 1; i >= 0; i--) {
        pipes[i].x -= 3.5;

        // Draw Pipes
        if (pipeImg.complete && pipeImg.naturalWidth !== 0) {
            ctx.drawImage(pipeImg, pipes[i].x, 0, 70, pipes[i].top);
            ctx.drawImage(pipeImg, pipes[i].x, pipes[i].bottom, 70, canvas.height);
        } else {
            ctx.fillStyle = "#2ecc71";
            ctx.fillRect(pipes[i].x, 0, 70, pipes[i].top);
            ctx.fillRect(pipes[i].x, pipes[i].bottom, 70, canvas.height - pipes[i].bottom);
        }

        // Collision (Improved Hitbox)
        if (bird.x + 5 < pipes[i].x + 70 && bird.x + bird.w - 5 > pipes[i].x) {
            if (bird.y + 5 < pipes[i].top || bird.y + bird.h - 5 > pipes[i].bottom) {
                endGame();
            }
        }

        // Improved Scoring (Checks if bird passed the pipe)
        if (!pipes[i].passed && pipes[i].x + 70 < bird.x) {
            score++;
            pipes[i].passed = true;
        }

        if (pipes[i].x + 70 < 0) pipes.splice(i, 1);
    }

    // Floor/Ceiling Check
    if (bird.y > canvas.height || bird.y < 0) endGame();

    // UI
    ctx.fillStyle = "white"; 
    ctx.font = "bold 25px Arial"; 
    ctx.textAlign = "left";
    ctx.fillText("Audit Score: " + score, 20, 40);
    
    frame++;
    requestAnimationFrame(draw);
}

function endGame() {
    isGameOver = true;
    music.pause();
    try { gameOverSound.play(); } catch(e) {}
    
    // Brief timeout so player sees the crash
    setTimeout(() => {
        alert("Audit Failed! Final Score: " + score);
        location.reload();
    }, 50);
}

const jump = (e) => { 
    if (e) e.preventDefault(); // Prevent double-tap zooming
    if (isGameOver) return;
    
    if(!gameStarted) { 
        gameStarted = true; 
        music.play().catch(() => {}); // Browsers require user interaction for music
    }
    bird.velocity = bird.lift; 
};

// Controls for Mobile & Desktop
window.addEventListener("keydown", (e) => { if(e.code === "Space") jump(); });
canvas.addEventListener("touchstart", jump, { passive: false });
canvas.addEventListener("mousedown", jump);

// Initialization
draw();
</script>
</body>
</html>
